paula.pasplugins integration test
=================================

Supposed to test integration with Plone and PAU.


PAU is up and running with our real and fake plugins
----------------------------------------------------

First of all, there should be a PAU and it should know about the credentials
plugin:

    >>> from zope.app.authentication.interfaces import \
    ...		IPluggableAuthentication
    >>> from zope.app.authentication.interfaces import \
    ...		ICredentialsPlugin
    >>> from paula.pasplugins.plugins.paucred import CREDPLUG_NAME

    >>> pau = getUtility(IPluggableAuthentication)
    >>> CREDPLUG_NAME in pau.credentialsPlugins
    True

    >>> credplug = getUtility(ICredentialsPlugin, name=CREDPLUG_NAME)
    >>> credplugs = list( pau.getCredentialsPlugins() )
    >>> len(credplugs)
    1
    >>> credplugs[0][0] == CREDPLUG_NAME
    True
    >>> credplugs[0][1] is credplug
    True


For further testing we use a fake authenticator plugin:

    >>> from zope.app.authentication.interfaces import \
    ...		IAuthenticatorPlugin
    >>> from paula.pasplugins.tests.fake_pau_ap import AUTHPLUG_NAME
    >>> from paula.pasplugins.tests.fake_pau_ap import AuthenticatorPlugin

    >>> len(pau.authenticatorPlugins)
    0

    >>> authplug = getUtility(IAuthenticatorPlugin, name=AUTHPLUG_NAME)
    >>> pau.authenticatorPlugins = (AUTHPLUG_NAME,)
    >>> authplugs = list( pau.getAuthenticatorPlugins() )
    >>> len(authplugs)
    1
    >>> authplugs[0][0] == AUTHPLUG_NAME
    True
    >>> authplugs[0][1] is authplug
    True


Ok, it should be possible to authenticate with PAU, using the credentials
for the fake user:

    >>> pau.authenticate(None)
    Traceback (most recent call last):
    ...
    AttributeError: ...

    >>> pau.authenticate(UserDict(login='foo',password='foo')) is None
    True

    >>> from paula.pasplugins.tests.fake_pau_ap import FAKE_REQUEST
    >>>	principal = pau.authenticate(FAKE_REQUEST)
    >>> principal.id is 'fakelogin'
    True

The user carries groups and properties provided by our fake testing
subscribers:

    >>> principal.a1
    1
    >>> principal.a2
    2
    >>> principal.b
    3
    >>> principal.groups
    ['fakegroup1', 'fakegroup2']


The user should also be returned for a getPrincipal call:

    >>> principal2 = pau.getPrincipal('fakelogin')
    >>> principal2.id
    'fakelogin'
    >>> principal2.a1
    1
    >>> principal2.a2
    2
    >>> principal2.b
    3
    >>> principal2.groups
    ['fakegroup1', 'fakegroup2']


PAU is working as expected.



Plone should be able to make use of all this
--------------------------------------------







#Set things up (thx optilux)
#---------------------------
#
#    >>> from Products.Five.testbrowser import Browser
#    >>> browser = Browser()
#    >>> portal_url = self.portal.absolute_url()
#
#The following is useful when writing and debugging testbrowser tests. It lets
#us see error messages properly.
#
#    >>> browser.handleErrors = False
#    >>> self.portal.error_log._ignored_exceptions = ()
#
#We then turn off the various portlets, because they sometimes duplicate links
#and text (e.g. the navtree, the recent recent items listing) that we wish to
#test for in our own views. Having no portlets makes things easier.
#
#    >>> from zope.component import getMultiAdapter, getUtility
#    >>> from plone.portlets.interfaces import IPortletManager
#    >>> from plone.portlets.interfaces import IPortletAssignmentMapping
#
#    >>> left_column = getUtility(IPortletManager, name=u"plone.leftcolumn")
#    >>> left_assignable = getMultiAdapter((self.portal, left_column), IPortletAssignmentMapping)
#    >>> for name in left_assignable.keys():
#    ...     del left_assignable[name]
#
#    >>> right_column = getUtility(IPortletManager, name=u"plone.rightcolumn")
#    >>> right_assignable = getMultiAdapter((self.portal, right_column), IPortletAssignmentMapping)
#    >>> for name in right_assignable.keys():
#    ...     del right_assignable[name]
#
#
#Start testing
#-------------
#
#Make sure all components have been registered
#
#    >>> from zope.app.security.interfaces import IAuthentication
#    
#    >>> from paula.authentication.interfaces import ILocalAuthenticatorPlugin
#    >>> from paula.authentication.interfaces import \
#    ...         ICredentialsFromMappingPlugin
#    >>> from paula.authentication.interfaces import IAuthProviders
#    >>> from paula.properties.interfaces import IPropertyProviders
#    >>> from paula.groups.interfaces import IMemberships
#
#    >>> pau = getUtility(IAuthentication, context=portal)
#    >>> pau.__parent__ = portal
#    >>> pau
#    <PluggableAuthentication at /plone/>
#    >>> ap = getUtility(ILocalAuthenticatorPlugin, context=portal, 
#    ...         name='Paula PAU AuthenticatorPlugin')
#    >>> ap.__parent__ = portal
#    >>> ap
#    <AuthenticatorPlugin at /plone/>
#    >>> cp = getUtility(ICredentialsFromMappingPlugin, context=portal, 
#    ...         name='Paula PAU CredentialsFromMappingPlugin')
#    >>> cp.__parent__ = portal
#    >>> cp
#    <CredentialsFromMappingPlugin at /plone/>
#    >>> apu = getUtility(IAuthProviders, context=portal)
#    >>> apu.__parent__ = portal
#    >>> apu
#    <RWAuthProviders at /plone/>
#    >>> ppu = getUtility(IPropertyProviders, context=portal)
#    >>> ppu.__parent__ = portal
#    >>> ppu
#    <RWPropertyProviders at /plone/>
#    >>> mu = getUtility(IMemberships, context=portal)
#    >>> mu.__parent__ = portal
#    >>> mu
#    <RWMemberships at /plone/>
#
#
#Add a user to the site
#
#    >>> from zope.component import createObject
#    >>> user = createObject('paula.ploneexamples.MinimalPloneUser', "user")
#    >>> user.title = u"user"
#    >>> user.password = u'password'
#    >>> user.email = u"foo@bar.com"
#    >>> user.realname = u"Foo Bar"
#    >>> portal['user'] = user
#
#credentials for the user, for PAU/Paula testing
#
#    >>> from zope.publisher.interfaces import IRequest
#    >>> pau_req = UserDict(login="user", password="password")
#    >>> alsoProvides(pau_req, IRequest)
#
#
#Add groups
#
#    >>> g1 = createObject('paula.ploneexamples.BasicGroup', 'g1')
#    >>> g1.title = 'g1'
#    >>> g1.members = ('user',)
#
#    >>> g2 = createObject('paula.ploneexamples.BasicGroup', 'g2')
#    >>> g2.title = 'g2'
#    >>> g2.members = ('g1',)
#    
#    >>> portal['g1'] = g1
#    >>> portal['g2'] = g2
#
#
#Test PAU/Paula subsystem
#
#    >>> principal = pau.authenticate(pau_req)
#    >>> principal
#    Principal('user')
#
#    >>> principal.email
#    u'foo@bar.com'
#    >>> principal.realname
#    u'Foo Bar'
#
#    >>> principal.groups
#    ['g1']
#
#
#Paula PAS auth plugin
#
#    >>> p = portal.acl_users.paula_auth.authenticateCredentials(pau_req)
#    >>> p
#    ('user', 'user')
#
#make a plone user
#
#    >>> from Products.PlonePAS.plugins.ufactory import PloneUser
#    >>> pu = PloneUser(p[1])
#    >>> pu
#    <PloneUser 'user'>
#
#Paula PAS properties plugin
#
#    >>> psheet = portal.acl_users.paula_properties.getPropertiesForUser(pu)
#    >>> psheet.propertyItems()
#    [('email', u'foo@bar.com'), ('realname', u'Foo Bar')]
#    
#Paula PAS group plugin
#
#    >>> portal.acl_users.paula_groups.getGroupsForPrincipal(pu)
#    ('g1',)
#
#
#try to authenticate
#
#    >>> browser.open(portal_url + '/login_form?came_from=' + portal_url)
#    >>> browser.getControl(name='__ac_name').value = u"user"
#    >>> browser.getControl(name='__ac_password').value = u"wrong"
#    >>> browser.getControl(name='submit').click()
#    >>> 'Login failed' in browser.contents
#    True
#
#    >>> browser.open(portal_url + '/login_form?came_from=' + portal_url)
#    >>> browser.getControl(name='__ac_name').value = u"user"
#    >>> browser.getControl(name='__ac_password').value = u"password"
#    >>> browser.getControl(name='submit').click()
#    >>> 'Login failed' in browser.contents
#    False
